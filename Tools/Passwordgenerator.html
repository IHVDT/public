<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Password Generator</title>
  <style>
    :root{--bg:#0f172a;--card:#111827;--muted:#94a3b8;--fg:#e5e7eb;--accent:#22c55e;--danger:#ef4444;--border:#1f2937}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; background:linear-gradient(180deg,#0b1020, #101727); color:var(--fg)}
    .wrap{max-width:900px;margin:40px auto;padding:24px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.3);overflow:hidden}
    header{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;gap:12px;align-items:center;justify-content:space-between}
    header h1{font-size:20px;margin:0;font-weight:700}
    header .badge{font-size:12px;color:#cbd5e1;background:#0b3; padding:4px 10px;border-radius:999px;filter:brightness(1.1)}
    .content{display:grid;grid-template-columns:1.2fr .8fr;gap:22px;padding:20px}
    @media (max-width:820px){.content{grid-template-columns:1fr}}
    .row{display:flex;gap:10px;align-items:center}
    .out{display:flex;gap:8px;align-items:center}
    .out input{flex:1;background:#0b1222;border:1px solid var(--border);color:var(--fg);padding:12px 14px;border-radius:12px;font-size:16px}
    button{border:1px solid var(--border);background:#0e1a32;color:var(--fg);padding:10px 14px;border-radius:12px;cursor:pointer}
    button:hover{filter:brightness(1.1)} button:active{transform:translateY(1px)}
    .btn-accent{background:#11331f;border-color:#184f2b}
    .btn-danger{background:#2e1111;border-color:#5b1a1a}
    .group{padding:14px;border:1px solid var(--border);border-radius:12px;background:#0b1222}
    .group h3{margin:0 0 10px;font-size:14px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
    label{display:flex;justify-content:space-between; align-items:center;gap:10px;margin:8px 0;color:#e2e8f0}
    label span.small{color:var(--muted);font-size:12px}
    input[type="range"]{width:100%}
    .meter{height:10px;border-radius:999px;background:#111827;border:1px solid var(--border);overflow:hidden}
    .meter > div{height:100%;width:0%;transition:width .25s ease}
    .meter.weak > div{background:var(--danger)}
    .meter.ok > div{background:#f59e0b}
    .meter.good > div{background:#3b82f6}
    .meter.strong > div{background:var(--accent)}
    .hint{color:var(--muted);font-size:12px}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .history{max-height:260px;overflow:auto;border:1px dashed #27324a;border-radius:12px;padding:10px}
    .pill{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;background:#0a0f1e;display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border:1px solid var(--border);border-radius:10px;margin:6px 6px 0 0}
    .muted{color:var(--muted)} .sep{opacity:.35;margin:0 6px}
    .kbd{border:1px solid var(--border);padding:2px 6px;border-radius:6px;background:#0b1222;font-size:12px}
    details.testlog{margin-top:12px;border:1px dashed #334155;border-radius:12px;padding:10px}
    details.testlog summary{cursor:pointer}
    .pass{color:#22c55e}
    .fail{color:#ef4444}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header>
        <h1>üîê Password Generator</h1>
        <span class="badge">client-side ‚Ä¢ no tracking</span>
      </header>

      <div class="content">
        <section>
          <div class="group">
            <h3>Resultaat</h3>
            <div class="out">
              <input id="output" type="text" readonly aria-label="Gegenereerd wachtwoord" />
              <button id="btnReg" class="btn-accent" title="Nieuw wachtwoord">Genereer</button>
              <button id="btnCopy" title="Kopieer naar klembord">Kopieer</button>
            </div>
            <div class="row" style="margin-top:10px; gap:16px; flex-wrap:wrap">
              <div style="flex:1;min-width:220px">
                <div class="meter" id="meter"><div></div></div>
                <div class="hint" id="strengthTxt">Sterkte: ‚Äì</div>
              </div>
              <div class="hint">Entropie: <span id="entropy">0</span> bits <span class="sep">‚Ä¢</span> <span class="muted">Dubbelklik om te verbergen/tonen</span></div>
            </div>
          </div>

          <div class="group">
            <h3>Instellingen</h3>
            <div class="grid">
              <label>
                <span>Lengte <span class="small" id="lenLbl">16</span></span>
                <input id="len" type="range" min="6" max="64" step="1" value="16" />
              </label>
              <label>
                <span>Min. complexe set afdwingen <span class="small">(minstens 1 van elke geselecteerde soort)</span></span>
                <input id="mustAll" type="checkbox" checked />
              </label>
              <label>
                <span>Hoofdletters (A‚ÄìZ)</span>
                <input id="useUpper" type="checkbox" checked />
              </label>
              <label>
                <span>Kleine letters (a‚Äìz)</span>
                <input id="useLower" type="checkbox" checked />
              </label>
              <label>
                <span>Cijfers (0‚Äì9)</span>
                <input id="useNums" type="checkbox" checked />
              </label>
              <label>
                <span>Symbolen (!@#$‚Ä¶)</span>
                <input id="useSyms" type="checkbox" />
              </label>
              <label>
                <span>Vermijd ambigu (O0, l1, {}[]()<>)</span>
                <input id="avoidAmb" type="checkbox" />
              </label>
              <label>
                <span>Geen herhalende karakters</span>
                <input id="noRepeat" type="checkbox" />
              </label>
            </div>
          </div>

          <div class="row" style="justify-content:space-between; margin-top:8px; flex-wrap:wrap; gap:8px">
            <div class="hint">Tip: druk <span class="kbd">R</span> om snel opnieuw te genereren, <span class="kbd">C</span> om te kopi√´ren.</div>
            <div>
              <button id="btnBulk">Genereer 10</button>
              <button id="btnClear" class="btn-danger">Wissen</button>
            </div>
          </div>

          <div class="group" style="margin-top:12px">
            <h3>Geschiedenis</h3>
            <div class="history" id="history" aria-live="polite"></div>
            <div class="hint">Klik op een item om te kopi√´ren.</div>
          </div>

          <details class="testlog" id="testlog">
            <summary>‚úÖ Zelftests (klik om te openen)</summary>
            <div id="testout" class="hint"></div>
          </details>
        </section>

        <aside>
          <div class="group">
            <h3>Uitleg</h3>
            <p class="hint">Alle logica draait in je browser. We sturen niets het internet op. De sterkte-indicator is gebaseerd op geschatte entropie (log‚ÇÇ van het te kiezen tekenuniversum tot de macht lengte), met extra punten als alle sets afgedwongen worden.</p>
            <ul class="hint">
              <li><strong>Groen</strong> = sterk (‚â• 80 bits)</li>
              <li><strong>Blauw</strong> = goed (60‚Äì79 bits)</li>
              <li><strong>Geel</strong> = ok√© (40‚Äì59 bits)</li>
              <li><strong>Rood</strong> = zwak (&lt; 40 bits)</li>
            </ul>
            <p class="hint">Gebruik voor echte wachtwoordbeheer <em>ook</em> een password manager. Ik ben slechts een generator, geen geheugen üòâ</p>
          </div>
        </aside>
      </div>
    </div>
  </div>

  <script>
  ;(() => {
    const $ = (id) => document.getElementById(id)
    const out = $("output"), len = $("len"), lenLbl = $("lenLbl"), meter = $("meter"), entropyEl = $("entropy"), sTxt = $("strengthTxt")
    const opts = {
      useUpper: $("useUpper"), useLower: $("useLower"), useNums: $("useNums"), useSyms: $("useSyms"),
      avoidAmb: $("avoidAmb"), mustAll: $("mustAll"), noRepeat: $("noRepeat")
    }

    // Ambigue tekens als expliciete lijst om escape-fouten te vermijden
    const ambSet = new Set(['O','0','o','I','l','1','{','}','[',']','(',')','<','>','|','`','\'','"','\\','\n','\r','\t',' '].map(x => x
      .replace('\\n','\n').replace('\\r','\r').replace('\\t','\t')))

    const sets = {
      upper: "ABCDEFGHIJKLMNOPQRSTUVWXYZ",
      lower: "abcdefghijklmnopqrstuvwxyz",
      nums:  "0123456789",
      syms:  "!@#$%^&*()-_=+[]{};:,.?/\\|~`<>"
    }

    function filtered(s){
      return opts.avoidAmb.checked ? [...s].filter(ch => !ambSet.has(ch)).join("") : s
    }

    function pick(set){
      return set[Math.floor(crypto.getRandomValues(new Uint32Array(1))[0] / 4294967296 * set.length)]
    }

    function shuffle(arr){
      // Fisher‚ÄìYates using crypto
      for(let i = arr.length - 1; i > 0; i--){
        const r = crypto.getRandomValues(new Uint32Array(1))[0] / 4294967296
        const j = Math.floor(r * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]]
      }
      return arr
    }

    function buildUniverse(){
      let U = "", slots = []
      if(opts.useUpper.checked){ const s = filtered(sets.upper); if(s) {U += s; slots.push(s)} }
      if(opts.useLower.checked){ const s = filtered(sets.lower); if(s) {U += s; slots.push(s)} }
      if(opts.useNums.checked){  const s = filtered(sets.nums);  if(s) {U += s; slots.push(s)} }
      if(opts.useSyms.checked){  const s = filtered(sets.syms);  if(s) {U += s; slots.push(s)} }
      return {U, slots}
    }

    function generateOne(){
      const L = parseInt(len.value,10)
      const {U, slots} = buildUniverse()
      if(!U){ alert("Selecteer minimaal √©√©n teken-set."); return "" }
      if(opts.noRepeat.checked && L > new Set(U).size){
        alert("'Geen herhaling' kan niet bij deze lengte + sets.")
        return ""
      }
      let chars = []
      if(opts.mustAll.checked && slots.length){
        // Zorg dat minstens 1 uit iedere set komt
        for(const s of slots){ chars.push(pick(s)) }
      }
      while(chars.length < L){
        const ch = pick(U)
        if(opts.noRepeat.checked && chars.includes(ch)) continue
        chars.push(ch)
      }
      chars = shuffle(chars).slice(0, L)
      return chars.join("")
    }

    function estimateEntropy(){
      const L = parseInt(len.value,10)
      const {U, slots} = buildUniverse()
      const N = new Set(U).size || 1
      // ruwe schatting: log2(N^L) = L*log2(N)
      let H = L * Math.log2(N)
      if(opts.mustAll.checked && slots.length > 1){ H += Math.log2(slots.length) } // mini-bonus voor enforced diversity
      return Math.round(H)
    }

    function strengthClass(H){
      if(H >= 80) return {cls:"strong", label:"Sterk"}
      if(H >= 60) return {cls:"good", label:"Goed"}
      if(H >= 40) return {cls:"ok", label:"Ok√©"}
      return {cls:"weak", label:"Zwak"}
    }

    function renderStrength(){
      const H = estimateEntropy()
      entropyEl.textContent = H
      const {cls, label} = strengthClass(H)
      meter.className = `meter ${cls}`
      const pct = Math.max(3, Math.min(100, Math.round((H/100)*100)))
      meter.firstElementChild.style.width = pct + "%"
      sTxt.textContent = `Sterkte: ${label}`
    }

    function generateAndShow(){
      const p = generateOne(); if(!p) return
      out.value = p
      renderStrength()
      addHistory(p)
    }

    function addHistory(pw){
      const el = document.createElement('span')
      el.className = 'pill'
      el.textContent = pw
      el.title = 'Klik om te kopi√´ren'
      el.addEventListener('click', () => copyText(pw))
      $("history").prepend(el)
    }

    async function copyText(text){
      // Gebruik eerst de beproefde execCommand-fallback (werkt in sandbox/iframes),
      // en val daarna pas terug op navigator.clipboard als beschikbaar.
      try{
        const ta = document.createElement('textarea')
        ta.value = text
        ta.setAttribute('readonly','')
        ta.style.position = 'fixed'; ta.style.opacity = '0'; ta.style.pointerEvents = 'none'
        document.body.appendChild(ta)
        ta.focus(); ta.select()
        const ok = document.execCommand('copy')
        ta.remove()
        if(ok){ toast('Gekopieerd!'); return }
      }catch(e){ /* ga door naar moderne API */ }

      try{
        if(navigator.clipboard && window.isSecureContext){
          await navigator.clipboard.writeText(text)
          toast('Gekopieerd!')
          return
        }
      }catch(e){ /* stil falen */ }

      // Laatste redmiddel
      toast('Kon niet kopi√´ren, selecteer en kopieer handmatig.')
    }

    let toastId
    function toast(msg){
      clearTimeout(toastId)
      let t = document.getElementById('toast')
      if(!t){
        t = document.createElement('div'); t.id='toast';
        Object.assign(t.style,{position:'fixed',bottom:'18px',right:'18px',padding:'10px 12px',background:'#0e1a32',border:'1px solid #1f2937',borderRadius:'10px',boxShadow:'0 8px 20px rgba(0,0,0,.35)',zIndex:50,color:'#e5e7eb'})
        document.body.appendChild(t)
      }
      t.textContent = msg
      t.style.opacity='1'
      toastId = setTimeout(()=>{t.style.opacity='0'},1400)
    }

    // Events
    $("btnReg").addEventListener('click', generateAndShow)
    $("btnCopy").addEventListener('click', () => out.value && copyText(out.value))
    $("btnBulk").addEventListener('click', () => { for(let i=0;i<10;i++) addHistory(generateOne()) })
    $("btnClear").addEventListener('click', () => { $("history").innerHTML = '' })

    len.addEventListener('input', () => { lenLbl.textContent = len.value; renderStrength() })
    for(const k in opts){ opts[k].addEventListener('change', renderStrength) }

    out.addEventListener('dblclick', () => { out.type = out.type === 'password' ? 'text' : 'password' })

    document.addEventListener('keydown', (e) => {
      if(e.key.toLowerCase() === 'r'){ e.preventDefault(); generateAndShow() }
      if(e.key.toLowerCase() === 'c'){ e.preventDefault(); if(out.value) copyText(out.value) }
    })

    // --- Zelftests ---------------------------------------------------------
    function runTests(){
      const logs = []
      const log = (ok, msg) => { logs.push(`<div class="${ok?'pass':'fail'}">${ok?'‚úî':'‚úñ'} ${msg}</div>`) }
      const save = () => { document.getElementById('testout').innerHTML = logs.join('') }

      // helper om opties tijdelijk te zetten
      const withOpts = (patch, fn) => {
        const snapshot = {
          useUpper: opts.useUpper.checked,
          useLower: opts.useLower.checked,
          useNums: opts.useNums.checked,
          useSyms: opts.useSyms.checked,
          avoidAmb: opts.avoidAmb.checked,
          mustAll: opts.mustAll.checked,
          noRepeat: opts.noRepeat.checked,
          len: len.value
        }
        Object.assign(opts.useUpper, {checked: patch.useUpper ?? snapshot.useUpper})
        Object.assign(opts.useLower, {checked: patch.useLower ?? snapshot.useLower})
        Object.assign(opts.useNums,  {checked: patch.useNums  ?? snapshot.useNums})
        Object.assign(opts.useSyms,  {checked: patch.useSyms  ?? snapshot.useSyms})
        Object.assign(opts.avoidAmb, {checked: patch.avoidAmb ?? snapshot.avoidAmb})
        Object.assign(opts.mustAll,  {checked: patch.mustAll  ?? snapshot.mustAll})
        Object.assign(opts.noRepeat, {checked: patch.noRepeat ?? snapshot.noRepeat})
        len.value = patch.len ?? snapshot.len
        try{ fn() } finally {
          Object.assign(opts.useUpper, {checked: snapshot.useUpper})
          Object.assign(opts.useLower, {checked: snapshot.useLower})
          Object.assign(opts.useNums,  {checked: snapshot.useNums})
          Object.assign(opts.useSyms,  {checked: snapshot.useSyms})
          Object.assign(opts.avoidAmb, {checked: snapshot.avoidAmb})
          Object.assign(opts.mustAll,  {checked: snapshot.mustAll})
          Object.assign(opts.noRepeat, {checked: snapshot.noRepeat})
          len.value = snapshot.len
        }
      }

      // Test 1: lengte binnen bereik
      withOpts({useUpper:true,useLower:true,useNums:true,useSyms:false,len:16,noRepeat:false,mustAll:true,avoidAmb:false}, () => {
        const pw = generateOne()
        log(pw.length === 16, 'Lengte 16')
      })

      // Test 2: mustAll garandeert ten minste 1 uit elke set
      withOpts({useUpper:true,useLower:true,useNums:true,useSyms:true,len:20,mustAll:true}, () => {
        const pw = generateOne()
        const cats = [/[A-Z]/,/[a-z]/,/\d/,/[!@#$%^&*()\-_=+\[\]{};:,.?/\\|~`<>]/]
        log(cats.every(rx => rx.test(pw)), 'Minstens √©√©n uit elke gekozen set (mustAll)')
      })

      // Test 3: noRepeat levert unieke chars (binnen haalbaarheid)
      withOpts({useUpper:true,useLower:false,useNums:false,useSyms:false,noRepeat:true,len:10}, () => {
        const pw = generateOne()
        const unique = new Set(pw)
        log(unique.size === pw.length, 'Geen herhaling bij noRepeat')
      })

      // Test 4: avoidAmb verwijdert ambigue tekens
      withOpts({useUpper:true,useLower:true,useNums:true,useSyms:true,avoidAmb:true,len:32}, () => {
        const pw = generateOne()
        const bad = [...ambSet].filter(ch => pw.includes(ch))
        log(bad.length === 0, 'Ambigue tekens vermeden')
      })

      // Test 5: entropie stijgt met universum
      withOpts({useUpper:true,useLower:false,useNums:false,useSyms:false,len:12}, () => {
        const H1 = estimateEntropy()
        withOpts({useLower:true}, () => {
          const H2 = estimateEntropy()
          log(H2 > H1, 'Entropie hoger bij groter universum')
        })
      })

      save()
    }

    // init
    renderStrength(); generateAndShow(); runTests()

    // Expose voor debug
    window._pwgen = {generateOne, estimateEntropy, buildUniverse, filtered, opts}
  })()
  </script>
</body>
</html>
